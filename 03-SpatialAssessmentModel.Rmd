# Spatial stock assessment model for Alaskan sablefish {#spatialmodeldescription}
The latest published stock assessment [@goethel2021assessment] is a sexually disaggregated integrated age-structured model. Let \(\boldsymbol{N_{r,y,s}}\) denote a vector of ages in year \(y\) sex \(s\) in region \(r\) (the partition) i.e., \(\boldsymbol{N_{r,y,s}} = (N_{1,r,y,s}, N_{2,r,y,s}, \dots, N_{a_+,r,y,s})^T\). 


## Process equations {-}

### Population dynamics {-}
The order of processes in the annual cycle are recruitment, total mortality, ageing then markovian movement. Before movement, the partition is updated as 
\begin{align*}
N_{a,r,y,s} = 
\begin{cases}
R_{r,y} 0.5, & a = a_1\\
N_{a - 1,r,y - 1,s} \exp\bigg( -Z_{a - 1,r, y - 1,s} \bigg), & a_1 < a < a_+\\
N_{a - 1,r,y - 1,s} \exp\bigg( -Z_{a - 1,r, y - 1,s} \bigg) + N_{a,r,y - 1,s} \exp\bigg( -Z_{a,r, y - 1,s} \bigg), &  a = a_+
\end{cases}
\end{align*}

and movement is then applied

\begin{equation*}
\boldsymbol{N}'_{a,y,s} = \boldsymbol{N}_{a,y,s} \boldsymbol{M} \ \ \forall \ a
\end{equation*}

where, \(\boldsymbol{N}'_{a,y,s} = (N'_{a,1,y,s}, \dots, N'_{a,n_r,y,s})\) denotes the numbers for age \(a\) across all regions after movement and \(\boldsymbol{M}\) is an \(n_r \times n_r\) movement matrix, which will move age cohort \(a\) among the regions based on the movement matrix.


### Initialisation {-}
An equilibrium age structure is derived following the method described in Chapter \@ref(spatialInit), but for completeness we will briefly describe it here. The annual cycle is run \(a_+ - a_1\) times (i.e., to populate all age cohorts prior to the plus group). Then, iterate the annual cycle one more time and calculate the number of individuals that moved into each regions plus age cohort, denoted by \(c^r_{a+}\). This will be the result of ageing, mortality and movement. The equilibrium plus group for region \(r\) is then calculated as

\[
N_{a+, r} = N_{a+ - 1, r} \frac{1}{1 - c^r_{a+}}  \  .
\]

After the equilibrium age-structure is calculated, there is an option to estimate global or region specific deviations to allow the model to start with a non-equilibrium age-structure

\[
N_{a, r} = N_{a, r} e^{\epsilon_a} \ \ \forall \ a \ r \ .
\]
To help with estimation there is a penalty on \(epsilon_a\) that assumes they are centered on zero with an estimable variance parameters. In general these parameters can be highly uncertain. The variance on these deviation parameters is often fixed at a low value which implies unless there is strong signal in the data the initial age-structure should be at an equilibrium.


### Growth {-}

Empirical length at age matrices were supplied for all years where sufficient age-length data was available and growth was assumed the same for all regions. Mean weight at age was calculated using an allometric length weight relationship with time and space invariant parameters \(\alpha\) and \(\beta\)

\[
\bar{w}_{a,y} = \alpha \bar{l}_{a,y}^{\beta} 
\]

**TODO** add the adjustment for lognormal distribution as in Casal2.

### Recruitment {-}
How to spatially apportion recruits in a way that is consistent with the data and isn't confounded with movement of young fish. There are two considerations, firstly looking at the AF and LFs there are regions that seem to have more young fish than others (link to figure and describe). However, there is very little information on spawning grounds and behavior. This coupled with a complex early life history make it difficult to a priori set regional apportionment of recruits, which would be ideal, an alternative is to estimate these as free parameters. This may introduce confounding when we start estimating movement which is believed to be ontogenetic.



### Tag release events {-}

Tags release events denoted by the index \(k\) have an implied region \(r\) and year \(y\) dimension. Each tag release is done by assuming a known age frequency of release. This is derived using the age-length key from the survey. They are denoted in the partition as \(N^k_{a,r,y,s}\), and are tracked for nine years before migrating into a pooled tag group. At present, they are assumed to take on the exact same population processes as the untagged elements of the partition.


## Observation equations {-}

As in the current stock assessment, there are the three conventional observational types in the spatial model

- Relative indices of abundance
- Age composition disaggregated by sex for the fixed gear fishery and longline survey
- Length composition disaggregated by sex for the trawl fishery 

The additional observational type relates to tag recoveries. 

### Catch at age {-}
Fishery dependent catch at age observations are available for the fixed gear fishery, but are also needed to calculate catch at length observations for the trawl fishery. Catch at age for fishery \(g\) is denoted by \({C}^g_{a,r,y,s}\) and model fitted values are calculated following

\begin{equation} 
  \widehat{C}^g_{a,r,y,s} = \frac{F^g_{a,r,y,s}}{Z_{a,r,y,s}}   N_{a,r,y,s} \left(1 - S_{a,r,y,s} \right)
\end{equation} 

Observed values were proportions with respect to age and sex, final model fitted proportions were
\[
\widehat{P}^g_{a,r,y,s} = \frac{\widehat{C}^g_{a,r,y,s}}{\sum_a \sum_s \widehat{C}^g_{a,r,y,s}},
\]
and initially the multinomial likelihood was assumed

\[
\boldsymbol{P}^g_{r,y} \sim \text{Multinomial}\left(\boldsymbol{\widehat{P}}^g_{r,y}, N^{eff}_{r,y}\right)
\]
where, \(N^{eff}_{r,y}\) is the effective sample size and \(\boldsymbol{P}^g_{r,y} = (P^g_{1,r,y,1}, \dots, P^g_{a_+,r,y,1}, P^g_{1,r,y,2}, \dots, P^g_{a_+,r,y,2})\) is the vector of observed proportions across all ages and sexs in year \(y\) and region \(r\), and \(\boldsymbol{\widehat{P}}^g_{r,y}\) has the same dimension (\(\sum_a \sum_s \widehat{P}^g_{a,r,y,s} = 1\)).


### Catch at length {-}
Catch at length observations are available for the trawl fishery. Model fitted values are derived by multiplying the catch at age (see above) by an age-length transition matrix denoted by \(\boldsymbol{A}^l_{y,s}\) (dimensions of \(\boldsymbol{A}^l_{y,s}\) are \(n_a \ \times \ n_l\) and its rows must sum to 1),

\begin{equation} 
  \widehat{\boldsymbol{Cl}}^g_{r,y,s} =  \left(\boldsymbol{A}^l_{y,s} \right)^T \ \times \ \widehat{\boldsymbol{C}}^g_{r,y,s}
\end{equation} 
where, \(\widehat{\boldsymbol{C}}^g_{r,y,s}\) is a column vector of catch at age (dimension \(n_a \ \times \ 1\)) at the beginning of year \(y\) in region \(r\) for sex \(s\), and \(\widehat{\boldsymbol{Cl}}^g_{r,y,s} \) is a column vector of catch at length (dimension \(n_l \ \times \ 1\)).


### Proportions at age {-}
Survey age composition data denoted by \({N}^s_{a,r,y,s}\) is available for the longline survey where model fitted numbers are derived as,

\begin{equation} 
  \widehat{N}^s_{a,r,y,s} = N_{a,r,y,s} \left(1 - \exp^{\delta_y Z_{a,r,y,s}}\right)S^s_{y,r,a,s}
\end{equation} 
where, \(\delta_y \in (0,1)\) is the proportion of time in the year that the observation occurs during year \(y\) and \(S^s_{y,r,a,s}\) is the survey selectivity.


### Relative abundance indices {-}
\begin{equation} 
  \widehat{I}^s_{r,y} = \sum_s\sum_a \widehat{N}^s_{a,r,y,s} \bar{w}_{a,y,s}
\end{equation} 
where, \(\bar{w}_{a,y,s}\) is mean weight at age, this can be omitted if the observation is in numbers i.e., abundance instead of biomass.

### Tag recovery observations {-}

When tagged fish are released, the observed length frequency is converted to an age frequency at release using the age-length key from the survey. Each recovery period for the tag release event \(k\) has the length frequency of recoveries, because we can link the release length to each recovery length we can calculate the age that each fish was at release by multiplying the length at release for fish recovered during the period by the age-length key at release and incrementing the age by the time-at liberty to derive age frequencies over a recovery period for a tag release group. This means the age-length conversion between releases and recoveries is consistent, but has the down side of smearing an a single length at release and recovery across multiple age bins. However, it does mitigate the problem highlighted in chapter \@ref(tagdata) (tag release section) of going backwards and forwards through the age-length transition matrix, which appears to be more problematic.

Release condition vs recapture condition


Can we assign tag-recoveries off Canada to EGOA? (sensitivity) i.e., Figure \@ref(fig:TagRecoveriesOutsideRegion)


## Considerations for determining the spatial resolution of the model {-}
This section will describe the decision making process we took in configuring a spatially explicit model for the Alaskan sablefish stock. The first consideration was whether to include areas outside of the Gulf of Alaska (GOA) and the Bering sea Aleutian islands region, which is the spatial extent for the current stock assessment [@goethel2021assessment]. Sablefish inhabit a broad spatial distribution from the northeastern Pacific Ocean from northern Mexico to the Gulf of Alaska. It is currently assessed by three assessment bodies, the first is the area of focus, being the Bering sea and gulf of Alaska [@goethel2021assessment], one off the west coast of Canada **(Cox et al. 2011)** and the west coast from California to Oregan **(Stewart et al. 2011)**. Given the complex juvenile life history coupled with long range movement capabilities of adults, the stock structure of sablefish has been a topic of extensive research.


A recent genetic study by @jasonowicz2017love, found no significant difference between samples off the west coast of US, GOA and bering sea (there were no samples off the west coast of Canada in this study), providing evidence for a single panmictic population. A recent morphometric study [@kapur2020oceanographic], found significant differences in fish traits such as length at age between samples from the west coast of US and GOA. These results were consitent with the findings from @tripp2012population. Tagging is another important information source with extensive tagging along the entire North pacific. Tag recovery data provide evidence for a two stock hypothesis [@kimura1998tagged]. With a stock north of Vancouver Island and a stock to the south. 


For the purposes of this research, we will assume GOA and BS, hereinafter refered to as the GOABS complex, is isolated (i.e., no movement in or out of this region) from Canada and the west coast of the US. Although there is evidence to include part of Canada (Figure \@ref(fig:TagRecoveriesOutsideRegion)). Due to practical considerations regarding data sharing and the time-frame of this research Canada was excluded. The focus of this research is to build and explore a spatially explicit model for the GOABS complex.

```{r TagRecoveriesOutsideRegion, out.width = '100%', fig.height= 6, fig.cap="Tag recoveries outside of stock boundaries, with release locations (bottom panel).", echo = F, eval = T}
include_graphics(file.path("Figures", "out_of_region_recoveries.png"))
```



The general approach taken, was to build an initial spatial model that had the finest spatial resolution possible and aggregate regions as due to data limitations, model convergence issues etc. This finest model spatial resolution was based on the input data with the coarsest reported spatial resolution. Data sets have been reported at different spatial resolutions over time. In general, data are reproted at three levels of spatial resolution: latitude and longitude (high spatial resolution), statistical area (Figure \@ref(fig:spatialstatArea)) and larger fishery management boundaries (Figure \@ref(fig:spatialmanagementArea)). Input data sets and the spatial resolution available are described in the following table.


```{r spatialstatArea, out.width = '100%', fig.height= 6, fig.cap="Statistical and reporting areas for GOABS complex", echo = F, eval = T}
include_graphics(file.path("Figures", "alaska-fisheries-boundaries-map.jpg"))
```


```{r spatialmanagementArea, out.width = '100%', fig.height= 5, fig.cap="Fishery management plan boundaries. The Eastern Gulf is often reported at subareas split up be East/West Yakutat and sometimes Southeast.", echo = F, eval = T}
include_graphics(file.path("Figures", "NFMP_with_EGOA.png"))
```

+------------------+---------------------------------------------------------------------------------------+
| Data source      | Description and spatial resolution                            
+==================+=======================================================================================+
| Catch pre 1900   | Available at FMP spatial resolution
|                  | 
+------------------+---------------------------------------------------------------------------------------+
| Catch post 1900  | Available at FMP spatial resolution 
|                  | 
+------------------+---------------------------------------------------------------------------------------+
| Observer data    | Latitude and Longitude positions
|  (Age,Length     | 
|   and  catch)    |
+------------------+---------------------------------------------------------------------------------------+
| Survey data      | Latitude and Longitude positions
|  (Age, Length    | 
|and  catch)       |
+------------------+---------------------------------------------------------------------------------------+
| Tagging data     | Latitude and Longitude for releases, 
|                  | Latitude and longitude for approximately half the recoveries
+------------------+---------------------------------------------------------------------------------------+

Reported catch from commercial fishers seems to be the data set which has the coarsest reported spatial resolution (check this statement with Dan. Are later data known to statistical areas?). For this reason, the finest spatial resolution we will consider is a Five area model based on the fishery management plan boundaries (FMP) being, Bering Sea, Aleutian Islands, Western Gulf, Central Gulf and Eastern Gulf. Although this was determined by a reporting constraint, this is also the spatial resolution that the stock is managed at.



In addition to the reported spatial resolution of the data, we need to consider if there is any spatial sampling stratification within a data set. Sampling designs that have spatially varying stratification and thus spatially varying sampling intensity, could be inappropriate to use for alternative spatial stratifications. Often retrospective design based estimators are not as efficient as design based estimators that are consistent with the sampling design. Fortunately in this case, the independent survey design is systematic. This results in consistent spatial sampling with respect to space, and removes this concern when considering alternative regional boundaries.



### Appendix {-}



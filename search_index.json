[["index.html", "SableFish stock assessment Chapter 1 Overview", " SableFish stock assessment C.Marsh 2022-11-17 Chapter 1 Overview This Gitbook documents our research for the Alaska sablefish (Anoplopoma fimbria) stock assessment. library(TMB) #library(stockassessmenthelper) library(ggplot2) library(dplyr) library(reshape2) #library(tidyr) "],["objectives.html", "Chapter 2 A list of objectives/milestones that we have set along the project life", " Chapter 2 A list of objectives/milestones that we have set along the project life Translate current stock assessment (Chapter 3) from ADMB to TMB. Planned date of completion is December 1 2022 Conduct self test using TMB model. Planned date of completion is December 1 2022 Consider improvements i.e., sex disaggregated composition data or sex ratio observations (look at the rock lobster assessment) including age-length observations or tag-increment observations to estimate growth internally. Characterize both fishery and survey data to get an idea of data limitations when considering spatially explicit stock assessment model. Develop a spatially explicit estimation model in TMB that generalizes the current assessment model. This requires a lot of thought, especially how we want to integrate the tagging data (Chapter 6) "],["modeldescription.html", "Chapter 3 Current Stock assessment model 3.1 Symbol Notation 3.2 Process equations 3.3 Observation equations Inference TODO", " Chapter 3 Current Stock assessment model The latest published stock assessment (Goethel et al. 2021) is a sexually disaggregated integrated age-structured model. Let \\(\\boldsymbol{N_{y,s}}\\) denote a vector of ages in year \\(y\\) for sex \\(s\\) (the partition) i.e., \\(\\boldsymbol{N_{y,s}} = (N_{1,y,s}, N_{2,y,s}, \\dots, N_{a_+,y,s})^T\\). The general process model is sequential and follows the general Equation (3.1), \\[\\begin{equation} \\boldsymbol{N_{y,s}} = \\begin{cases} g\\left(\\boldsymbol{\\theta}\\right), &amp; y = 1959 \\text{ Initial model year}\\\\ f\\left(\\boldsymbol{N_{y-1,s}}|\\boldsymbol{\\theta}\\right), &amp; y &gt; 1959 \\\\ \\end{cases} \\tag{3.1} \\end{equation}\\] where, \\(g(.)\\) is the function describing initial conditions for the partition and \\(f(.)\\) is the function that applies populations dyanmics each year i.e., birth, death, growth and migration. See Section 3.1 &amp; 3.2 for a detailed description of \\(g(.)\\) and \\(f(.)\\) and \\(\\boldsymbol{\\theta}\\) is the set of estimable (not all are estimated) parameters. Maximum Likelihood Estimates (MLE) for estimated parameters \\(\\widehat{\\boldsymbol{\\theta}}_{MLE}\\) are evaluated, \\[\\begin{equation} \\widehat{\\boldsymbol{\\theta}}_{MLE} = \\underset{\\boldsymbol{\\theta}}{\\arg\\max} \\left( L\\left(\\boldsymbol{\\theta} | \\boldsymbol{y^{obs}}\\right) \\right) \\tag{3.2} \\end{equation}\\] where, \\(\\boldsymbol{y^{obs}}\\) is a set of observations and \\(L\\left( . \\right)\\) is an objective function that is made up of priors/penalties and log-likelihood. See Section 3.3 3.1 Symbol Notation Symbol Description \\(y\\) Year, \\(y = 1960, \\dots, T\\) \\(T\\) Terminal year of the model \\(s\\) Sex index \\(s \\in \\{1,2\\}\\) \\(r\\) Region index \\(r \\in \\{1, \\dots, n_r\\}\\) \\(n_r\\) number of modeled regions \\(a\\) Model age cohort, i.e., \\(a = a_0, a_0 + 1, \\dots\\) \\(a_{1}\\) Recruitment age to the model = 2 \\(a_+\\) Plus-group age class (oldest age considered plus all older ages) \\(n_a\\) Number of age classes modeled \\(a_+ \\ - a_1\\) \\(l\\) length class \\(n_l\\) Number of length classes \\(g\\) gear type index, i.e. longline survey, longline fishery, trawl fishery \\(x\\) log-likelihoos index \\(\\bar{w}_{a,y, s}\\) Average weight at age \\(a\\), year \\(y\\) and sex \\(s\\) \\(\\phi_{a,y}\\) Proportion of female mature by age and year \\(p^s_{y}\\) Proportion of recruits for sex \\(s\\). Often assumed = 0.5 \\(\\ln \\mu_{r}\\) Average log-recruitment \\(\\ln \\mu_{f}\\) Average log-fishing mortality \\(\\phi_{y,g}\\) annual fishing mortality deviation by gear (log space) \\(\\tau_{y}\\) annual recruitment deviation \\(\\sim LogNormal\\left(0,\\sigma_r\\right)\\) \\(\\sigma_r\\) Recruitment standard deviation \\(N_{a,y,s}\\) Numbers of fish at age \\(a\\) in year \\(y\\) of sex \\(s\\) \\(M\\) Natural mortality \\(F^g_{a,y}\\) Fishing mortality for year \\(y\\), age \\(a\\) and gear \\(g\\) \\(F_{hist}\\) Historical proportion of Fishing mortality \\(Z_{a,y}\\) Total mortality for year \\(y\\), age \\(a\\) \\(=\\sum\\limits_g F^g_{a,y} + M\\) \\(R_{y}\\) Annual recruitment \\(B_{y}\\) Spawning biomass in year \\(y\\) \\(S^g_{a,y,s}\\) Selectivity at age \\(a\\) for gear type \\(g\\) and sex \\(s\\) \\(a_50\\) age at 50% selection for ascending limb \\(d_50\\) age at 50% selection for descending limb \\(\\delta\\) slope/shape parameters for different logistic curves \\(\\boldsymbol{A}\\) ageing-error matrix dimensions \\(n_a \\ \\times \\ n_a\\) \\(\\boldsymbol{A}^l_s\\) age to length conversion matrix by sex. dimensions \\(n_a \\ \\times \\ n_l\\) \\(q_g\\) abundance index catchability coeffecient by gear \\(\\lambda_x\\) Statistical weight (penalty) for component \\(x\\) \\(P^g_{l,y,s}\\) Observed proportions at length for gear \\(g\\) in year \\(y\\) and sex \\(s\\) \\(P^g_{a,y,s}\\) Observed proportions at age for gear \\(g\\) in year \\(y\\) and sex \\(s\\) \\(\\psi^g_{y}\\) assumed sample size for gear \\(g\\) in year \\(y\\) (for multinomial likelihood \\(n_g\\) Number of years that age (or length) composition is available for gear \\(g\\) 3.2 Process equations Initialisation (\\(g\\left(.\\right)\\)) \\[\\begin{align*} N_{a,1,s} = \\begin{cases} R_1, &amp; a = a_1\\\\ \\exp\\bigg( \\mu_r + \\tau_{a_1 - a + 1}\\bigg) \\exp-\\bigg( a - a_1\\bigg) \\bigg( M + F_{hist} * \\mu_{LL} * S^{LL}_{a,1}\\bigg), &amp; a_0 &lt; a &lt; a_+\\\\ \\exp( \\mu_r) \\exp-( a - 1) ( M + F_{hist} * \\mu_{LL} * S^{LL}_{a - 1,1})(1 - \\exp( M + F_{hist} * \\mu_{LL} * S^{LL}_{a - 1,1}))^{-1}, &amp; a = a_+ \\end{cases} \\end{align*}\\] Population dynamics (\\(f\\left(.\\right)\\)) The assessment assumes a closed population that is only effected by mortality (natural and fishing), recruitment and growth. Mortality is applied assuming \\[ Z_{a,y,s} = M + \\sum_g F^g_{y} S^g_{a,y,s} \\] where, \\(S^g_{a,y,s}\\) is the fishery selectivity and \\(F^g_{y}\\) is the annual estimated fishing mortality. The annual cycle follows, \\[\\begin{align*} N_{a,y,s} = \\begin{cases} p^s_{y} R_y, &amp; a = a_1\\\\ N_{a - 1,y - 1,s} \\times \\exp\\bigg( -Z_{a - 1,y - 1,s} \\bigg), &amp; a_0 &lt; a &lt; a_+\\\\ \\exp\\bigg( -Z_{a - 1,y - 1,s} \\bigg) + \\exp\\bigg( -Z_{a,y - 1,s} \\bigg), &amp; a = a_+ \\end{cases} \\end{align*}\\] where, \\[ R_y = \\exp\\{\\mu_r + \\tau_y + 0.5\\sigma_R^2\\} \\] Determining selectivities for fisheries and surveys The ADMB model has a hard coded number of selectivities. Some of them relate to changes in the fishery and so represent time-varying blocks. We want to spell these out and simplify for the TMB model. There are nine selectivities labelled fish1, fish2, fish3, fish4, fish5, srv1, srv2 and srv10. label Selectivity description fish1 Longline selectivity from 1960-1994 fish2 Not sure if this is used, maybe this is used for srv6? fish3 Trawl selectivity from 1960 - \\(T\\) fish4 Longline selectivity from 1995 -\\(\\ IFQ_y\\) (\\(IFQ_y\\) can = \\(T\\) fish5 Longline selectivity from \\(IFQ_y \\ - \\ T\\) if there is post IFQ block srv1 Domestic Longline survey selectivity srv2 Japanese Longline survey selectivity 3.3 Observation equations Three are three observational types in the current Sablefish stock assessment - Relative abundance indices - Age composition (aggregated over sex) - Length composition (disaggregated by sex) These three observation types come from both fishery dependent i.e., observer programs and CPUE and fishery independent i.e., research surveys. Catch at age Fishery dependent catch at age observations for gear type \\(g\\) denoted by \\(\\boldsymbol{C^g}_{a,y,s}\\) are calculated as follows \\[\\begin{equation} \\boldsymbol{C^g}_{a,y,s} = \\frac{F^g_{a,y,s}}{Z_{a,y,s}} N_{a,y,s} \\left(1 - S_{a,y,s} \\right) \\tag{3.3} \\end{equation}\\] Currently all age observations are sex aggregated which means the model expected values before applying ageing error is \\[ \\boldsymbol{C^g}_{a,y} = 0.5 \\sum_s \\frac{\\boldsymbol{C^g}_{a,y,s}}{\\sum_a\\boldsymbol{C^g}_{a,y,s}} \\] why the 0.5? should be omitted going forward. Ageing error is then incorporated and the values are normalized so that they are proportions, before being passed to the multinomial log-likelihood function. Survey age composition is similar but instead of being a function of \\(F\\) it is calculated at the beginning of the year. For survey \\(k\\) the numbers at age are denoted by \\(\\boldsymbol{C^k}_{a,y}\\) and calculated following \\[\\begin{equation} \\boldsymbol{C^k}_{a,y} = p^s N_{a,y,s} S^k_{y,a,s} \\tag{3.4} \\end{equation}\\] I am not sure exactly what the timing of these surveys are, but do we need to account for som mid-year mortality? or changes in timing of the survey? if so we could easily replace \\[ N_{a,y,s} \\] with \\[ N_{a,y,s} \\exp\\{-p^k_y Z_{a,y,s}\\} \\] where,\\(p^k_y\\) is the proportion of mortality that we want to account for in year \\(y\\) for survey \\(k\\). The survey numbers at age are then adjusted for ageing error and normalised so they sum to one for each year. Relative abundance indices \\[\\begin{equation} \\widehat{I}^g_{y} = \\sum_s\\sum_a p^s N_{a,y,s} \\exp \\{-0.5 Z_{a,y,s}\\} S^g_{y,a,s} \\bar{w}_{a,y,s} \\tag{3.5} \\end{equation}\\] where, \\(\\bar{w}_{a,y,s}\\) is mean weight at age, this can be omitted if the observation is in numbers i.e., abundance instead of biomass and \\(p^s\\) is the proportion for each sex. This is currently a user input, but should be dealt within the model either as having different sex selectivities or through the sex ratio of recruitment. A list of slight improvements change how sex ratio is handled fishery dependent abundance indices i.e., CPUE change \\(N_{a,y,s} \\exp \\{-0.5 Z_{a,y,s}\\}\\) with \\(\\boldsymbol{C^g}_{a,y,s}\\) which is calculated in the catch at age observations. Catch at length For each year that has a length frequency observation, numbers at length denoted by \\(\\boldsymbol{C^l}_{y,s} = (C^l_{1,y,s}, \\dots, C^l_{n_l,y,s})^T\\) (dimension of \\(\\boldsymbol{C^l}_{y,s}\\) is \\(n_l \\ \\times \\ 1\\)) were calculated for each sex. This involved multiplying the catch at age (see above for how it is calculated) through an age-length transition matrix denoted by \\(\\boldsymbol{A}^l_{y,s}\\) (dimensions of \\(\\boldsymbol{A}^l_{y,s}\\) are \\(n_a \\ \\times \\ n_l\\) and its rows must sum to 1). The calculation follows Equation (3.6), \\[\\begin{equation} \\boldsymbol{C^l}_{y,s} = \\left(\\boldsymbol{A}^l_{y,s} \\right)^T \\ \\times \\ \\boldsymbol{C_{y,s}} \\tag{3.6} \\end{equation}\\] where, \\(\\boldsymbol{C_{y,s}}\\) is a column vector of numbers at age (dimension \\(n_a \\ \\times \\ 1\\)) at the beginning of year \\(y\\) for sex \\(s\\). Observations for fisheries and surveys label Relative Abundance description srv1 Biomass domestic longline survey uses both srv1_sel and srv10_sel srv3 Abundance domestic longline survey uses both srv1_sel and srv10_sel srv2 Biomass survey uses both srv2_sel and srv9_sel srv4 Abundance survey uses both srv2_sel and srv9_sel srv5 Longline fishery CPUE fish1_sel, fish4_sel, fish5_sel srv6 Japanese LL fishery CPUE srv7 NMFS bottom trawl survey (currently GOA only; fit in model) label Composition description ac_fish1 Longline Fishery Age Comp (sex aggregated) sc_fish1 Longline Fishery LF (sex dis-aggregrated) sc_fish3 Trawl Fishery LF (sex disaggregrated) sc_fish2 LF for japaneses Longline fishery (sex aggregrated) (basically a survey now) sc_fish4 LF for japaneses Longline fishery (sex aggregrated) (basically a survey now) fish_size LF From japaneses trawl survey? (sex aggregrated) ac_srv1 Domestic Longline Survey AF (sex aggregated) sc_srv1 Domestic Longline Survey LF (sex disaggregrated) ac_srv2 Japanese Longline Survey AF (sex aggregated) sc_srv2 Japanese Longline Survey LF (sex disaggregrated) ac_srv7 NMFS bottom trawl survey AF (sex aggregated) sc_srv7 NMFS bottom trawl survey LF (sex disaggregrated) Inference If random effects are considered the joint probability model follows, \\[\\begin{equation} Pr\\left[ \\boldsymbol{y^{obs}}, \\boldsymbol{u}| \\boldsymbol{\\theta} \\right] = Pr\\left[\\boldsymbol{y^{obs}} |\\boldsymbol{\\theta^f}, \\boldsymbol{u} \\right] Pr\\left[\\boldsymbol{u} |\\boldsymbol{\\theta^h} \\right] \\end{equation}\\] Inference is conducted by maximising the marginal likelihood noting \\(L\\left(\\boldsymbol{\\theta} | \\boldsymbol{y^{obs}} \\right) \\propto Pr\\left[ \\boldsymbol{y^{obs}} | \\boldsymbol{\\theta} \\right]\\) \\[\\begin{equation}\\label{eq:marginal_ll} L\\left(\\boldsymbol{\\theta} | \\boldsymbol{y^{obs}}\\right) = \\int \\left(Pr\\left[\\boldsymbol{y^{obs}} |\\boldsymbol{\\theta^f}, \\boldsymbol{\\theta^g}, \\boldsymbol{u} \\right] Pr\\left[\\boldsymbol{u} |\\boldsymbol{\\theta^h} \\right] \\right) \\boldsymbol{du} \\end{equation}\\] In general this integral is not tractable, and so approximations are necessary. The software used here implement the Laplace approximation, which relies on Gaussian assumptions. Maximum Likelihood Estimates (MLE) for fixed effect parameters \\(\\widehat{\\boldsymbol{\\theta}}_{MLE}\\) are evaluated, \\[\\begin{equation} \\widehat{\\boldsymbol{\\theta}}_{MLE} = \\underset{\\boldsymbol{\\theta}}{\\arg\\max} \\left( L\\left(\\boldsymbol{\\theta} | \\boldsymbol{y^{obs}}\\right) \\right) \\end{equation}\\] and Empirical Bayes estimates are evaluated for \\(\\widehat{\\boldsymbol{u}}\\), which are used model diagnostics and other model quantities, \\[\\begin{equation} \\widehat{\\boldsymbol{u}} = \\underset{\\boldsymbol{u}}{\\arg\\max} \\left( Pr\\left[ \\boldsymbol{y^{obs}}, \\boldsymbol{u}| \\widehat{\\boldsymbol{\\theta}}_{MLE} \\right] \\right) \\end{equation}\\] TODO Build a validate function to help catch users setting up parameters or data structures that will cause a crash once supplied to TMB. Self test change some parameter containers. In the ADMB model the often share parameters between male and females. Particularly for selectivity parameters. However TMB will not allow us to fix/map parameters across different arrays or vectors. This means we will want to join the male and female selectivity parameter objects into a single object so that we can share parameters between the sexes. Change array column casting from vector&lt;Type&gt;(array.col(i)) to array.col(i).vec() References "],["sexratios.html", "Chapter 4 Exploring methods for sex ratios in age and length composition data Other things to consider", " Chapter 4 Exploring methods for sex ratios in age and length composition data One of the needed improvements is dealing with sex ratios in the compositional data. Currently it is difficult to see how there is any information on sex ratio in the Sablefish stock assessment given how the observations are structured (Chapter 3) (Caveat is users can provide an observed sex ratio for observations etc which is similar to the approach in Ward et al. (2019)). I am aware of two approaches for supplying observations that in theory should provide information on sex ratio. The first was taken from Casal2 (Doonan et al. 2016). This treats sexed composition data for a year as a single proportion i.e., proportions across all ages and sexes sum to one for each year of observation. Catch at age (in numbers) for both sexes is denoted by \\(\\boldsymbol{C^k}_{a,y} = (\\boldsymbol{C^k}_{a,y,1},\\boldsymbol{C^k}_{a,y,2})\\), where \\(\\boldsymbol{C^k}_{a,y,1}\\) is the catch at age for males and \\(\\boldsymbol{C^k}_{a,y,2}\\) is for females, and \\[ \\boldsymbol{P^k}_{a,y} = \\frac{\\boldsymbol{C^k}_{a,y}}{\\sum_a \\sum_s \\boldsymbol{C^k}_{a,y,s}} \\] The second approach is to provide a specific sex ratio observation over all ages or lengths as done in the New Zealand rock lobster stock assessment (Webber, Rudd, and Starr 2021). \\[ R^k_{y,s} = \\frac{\\sum_a \\boldsymbol{C^k}_{a,y,s}}{\\sum_a \\sum_s \\boldsymbol{C^k}_{a,y,s}} \\] A simple simulation experiment was conducted to explore the benefits of each approach. There were two OM scenarios that we wanted to explore, the first was that the true population had a 50:50 sex ratio and the observations had skewed sex ratios due to the selectivity i.e., availability to the survey fishery. Second the selectivity was constant for both sexes but the sex ratio was skewed at recruitment. Other things to consider LF observations with sexual dimorphism in growth. A possible reason LF’s could be influencing assessment output is due to mis-specified growth ala References "],["Fexplore.html", "Chapter 5 Exploring alternative fishing mortality parameterisations (F) Set up a simulation Other things to consider", " Chapter 5 Exploring alternative fishing mortality parameterisations (F) The current Alaskan Sablefish stock assessment (Chapter 3), fishing mortality has estimable parameters for each gear \\(g\\) and year \\(y\\). This parametersation poses to potential problems. The first is that the number of parameters will increase as the number of gears increase. The fishery is currently going through a transformation whereby there is a switch from longline to pots. The second consideration is how how to set this up in a spatially explicit model where catch have an added spatial dimension. There are two alternative approaches to the current approach which treat \\(F\\) as a derived quantity rather than an estimable parameter. The first is to use newton rahpson methods to solve \\(F\\) as is done in the “hybrid” method of Stock Synthesis (Methot Jr and Wetzel 2013). The second … A quick overview of the commonly applied fishing dynamics applied in stock assessment models. A good general overview is by Branch (2009). They compare the continuous Baranov Catch equation (Baranov 1918) vs Pope’s discrete formulation (Pope 1972). Arguments for using the continuous case is that \\(M\\) and \\(F\\) occur simultaneously, also with the continuous case, \\(F\\) allows for multiple event encounters, this is assuming a fleet has the same selectivity and availability, that a fish that escapes one net can be caught in another. In contrast, the discrete formulation only allows a fish to be caught or escape from an instantaneous event. I have summarized the benefits of the continuous equation in the following list, Allows the entire population to be caught (not sure this is that relevant) Allows simultaneous \\(M\\) and \\(F\\), no need to worry about order of operations. From a coding/practical perspective this is quite attractive. Once you have an F and M you can easily derive all mid-mortality quantities. Where as using the \\(U\\) approach you need save the population before and after to interpolate to derive mid-mortality quantities. \\(F\\) effects Composition data, where as in the discrete case composition is independent of \\(U\\). Allows for multiple catch events of an individual Can fit to catch thus allows for uncertainty in catches The arguments for the discrete approximation is that there is an analytical solution for \\(U\\) and so is fast to calculate expected catch, where as \\(F\\) has to be either solved numerically or estimated as a free parameter. Chris Francis’s wrote a response to this paper (Francis 2010) where he argues the discrete formulation does not preclude the multiple encounters and that only the data can truly tell us which catch equation is the best one to use. The relationship between \\(F\\) (Instantaneous fishing mortality) and \\(U\\) exploitation rate for a simple scenario (single fishery) is given in the following R code. Set up a simulation bio_params = list( ages = 1:20, L_inf = 58, K = 0.133, t0 = 0, M = 0.15, a = 2.08e-9, ## tonnes b = 3.5, m_a50 = 6.3, m_ato95 = 1.2, sigma = 0.6, h = 0.85, sigma_r = 0.6, R0 = 8234132, plus_group = 1 # 0 = No, 1 = Yes ) other_params = list( s_a50 = 3.6, s_ato95 = 2, s_q = 0.2, f_a50 = 5, f_ato95 = 2, ssb_prop_Z = 0.5, survey_prop_Z = 0.5, survey_age_error = c(0.5, 0.4), ## sd, rho (ignored if iid) fishery_age_error = c(0.5, 0.4), ## sd, rho (ignored if iid) survey_bio_cv = c(0.1) ) ages = bio_params$ages max_age = max(bio_params$ages) n_years = 30 years = (2020 - n_years + 1):2020 n_ages = length(ages) ## annual fishing mortality start_F = c(rlnorm(10, log(seq(from = 0.05, to = 0.2, length = 10)), 0.1), rlnorm(10, log(0.13), 0.1), rlnorm(10, log(0.07), 0.1)) recruit_devs = log(rlnorm(n_years, -0.5 * bio_params$sigma_r * bio_params$sigma_r, bio_params$sigma_r)) length_at_age = vonbert(bio_params$ages, bio_params$K, bio_params$L_inf, bio_params$t0) fishery_ogive = logis(bio_params$ages, other_params$f_a50, other_params$f_ato95) survey_ogive = logis(bio_params$ages, other_params$s_a50, other_params$s_ato95) mat_age = logis(bio_params$ages, bio_params$m_a50, bio_params$m_ato95) weight_at_age = bio_params$a * length_at_age^bio_params$b ## observation temporal frequency survey_year_obs = years survey_ages = 1:20 fishery_year_obs = years fishery_ages = 1:20 ################################## ### Build TMB OM with Multinomial ################################## #dyn.unload(dynlib(file.path(&quot;TMB&quot;,&quot;SimpleAgeStructuredModel&quot;))) compile(file.path(&quot;TMB&quot;,&quot;SimpleAgeStructuredModel.cpp&quot;), flags = &quot;&quot;,DLLFLAGS=&quot;&quot;); ## [1] 0 dyn.load(dynlib(file.path(&quot;TMB&quot;,&quot;SimpleAgeStructuredModel&quot;))) ## tolerance form model convergence, all gradients need to be less than this. grad_tol = 0.001 # these parameters we are not estimating. na_map = fix_pars(par_list = true_pars, pars_to_exclude = c(&quot;ln_catch_sd&quot;, &quot;trans_survey_error&quot;, &quot;trans_fishery_error&quot;,&quot;ln_extra_survey_cv&quot;,&quot;ln_sigma_r&quot;)) ASM_obj &lt;- MakeADFun(TMB_data, true_pars, DLL= &quot;SimpleAgeStructuredModel&quot;, map = na_map) ## Constructing atomic invpd ## Constructing atomic D_lgamma true_report = ASM_obj$report() ################################## ### Self Test ################################## n_sims = 100 est_pars = NULL ssbs = NULL for(sim_iter in 1:n_sims) { if(sim_iter %% 10 == 0) cat(&quot;iter = &quot;, sim_iter, &quot;\\n&quot;) sim_data = ASM_obj$simulate(complete = T) start_pars = ran_start_vals(covar = &quot;ar1&quot;) est_model = MakeADFun(sim_data, start_pars, DLL= &quot;SimpleAgeStructuredModel&quot;, map = na_map, silent = T) opt_modelc = nlminb(est_model$par, est_model$fn, est_model$gr, control = list(iter.max = 10000, eval.max = 10000)) est_pars = rbind(est_pars, opt_modelc$par) est_rep = est_model$report(opt_modelc$par) ssbs = rbind(ssbs, est_rep$ssb) } ## iter = 10 ## iter = 20 ## iter = 30 ## iter = 40 ## iter = 50 ## iter = 60 ## iter = 70 ## iter = 80 ## iter = 90 ## iter = 100 molten_ssbs = melt(ssbs) colnames(molten_ssbs) = c(&quot;sim&quot;, &quot;year&quot;, &quot;value&quot;) ggplot() + geom_line(data =molten_ssbs, aes(x = year, y = value, group = sim)) + geom_line(data = data.frame(year = 1:31, value = true_report$ssb),aes(x = year, y = value), col = &quot;red&quot;, linetype = &quot;dashed&quot;, linewidth = 1.2) + ylim(0,NA) + labs(x = &quot;Time&quot;, y = &quot;SSB (t)&quot;) + theme_bw() Other things to consider References "],["tagdata.html", "Chapter 6 Tagging data and studies Laslett–Eveson–Polacheck (LEP) Simulation test the “LEP” method Next steps", " Chapter 6 Tagging data and studies Since 1972 there have been approximately 400 000 sablefish tagged in Alaska waters, of which over 38 500 have been recovered. Although there is extensive and long term tagging data, this information is not currently directly included in the stock assessment (Goethel et al. 2021). Laslett–Eveson–Polacheck (LEP) Going to investigate the use of “Laslett–Eveson–Polacheck (LEP)” based on Laslett, Eveson, and Polacheck (2002) &amp; Eveson, Laslett, and Polacheck (2004) as described in Aires-da-Silva et al. (2015). The idea is to use a single growth model that fits to two observational data sets (ideally within the assessment, however we will start outside for now. When including it in the assessment you will also have LF data to help inform growth). The first will describe age-at-length data from direct ageing. The second will be length increment data from tagging experiments. Age-at-length growth model We start by using the Richards growth curve following Aires-da-Silva et al. (2015) (but this could be extended). The Richards growth formulation follows \\[\\begin{equation} \\bar{l}_{a} = L_{\\infty} \\left( 1 + \\frac{1}{p} \\exp \\{-K(a - a_0)\\}\\right)^{-p} \\tag{6.1} \\end{equation}\\] where, \\(\\bar{l}_{a}\\) is the mean length at age \\(a\\), \\(L_{\\infty}\\) is the asymptotic length, \\(K\\) is the growth coefficient and \\(p\\) is a shape parameter that is related to the ratio \\(\\bar{l}_{a} / L_{\\infty}\\) at the inflexion point. Tag recapture growth data Symbol Description \\(l_{1,i}\\) length of individual \\(i\\) at release \\(l_{2,i}\\) length of individual \\(i\\) at recapture \\(a_{1,i}\\) age of individual \\(i\\) at release. Denoted as \\(A\\) in Aires-da-Silva et al. (2015) \\(a_{2,i}\\) age of individual \\(i\\) at recapture \\(\\Delta_t\\) Time at liberty \\(\\Delta_t = a_{2,i} - a_{1,i}\\) Just one comment on notation!!! in most all the papers that use this method, they ignore the individual notation of \\(A\\). That is not an issue in general however it confuses me when they describe the prior on this. The sub-models for the release and recapture lengths follow, \\[\\begin{equation} l_{1,i} = L_{\\infty} \\left( 1 + \\frac{1}{p} \\exp \\{-K(a_{1,i} - a_0)\\}\\right)^{-p} \\tag{6.2} \\end{equation}\\] and, \\[\\begin{equation} l_{2,i} = L_{\\infty} \\left( 1 + \\frac{1}{p} \\exp \\{-K(a_{1,i} + \\Delta_t - a_0)\\}\\right)^{-p} \\tag{6.3} \\end{equation}\\] The above growth model assumes that we know the age at recovery \\(a_{2,i}\\). The problem we have is, we have 22 569 tag recoveries with length information but only a handful of these have been aged. This is dealt with by modelling \\(a_{1,i}\\) as a random effect i.e., \\(a_{1,i} \\sim LN \\left(\\mu, \\sigma^2\\right)\\). What confuses is me here is how to assign a hyper distribution like the one above for the random effect variables \\(a_{1,i}\\). \\(a_{1,i}\\) is expected to vary quite a bit because tagged fish at release have a broad length frequency and thus is expected to have a broad age at release? (ask someone about this because I may be misunderstanding something). Simulation test the “LEP” method ## going to use parameters from Aires-da-Silva et al. (2015) Table 1 integrated analysis L_inf = 200.8 k = 0.44 t_0 = 1.26 p = -4.27 cv = 0.15 ## cv of length around length at age ## selectivity paraemters sel_a50 = 1.3 sel_ato95 = 0.8 ## sample sizes for simulation n_sample_release = 1000 n_sample_recoveries = 1000 * 0.1 ## about the recovery rate from sablefish data n_sample_age_length = 1000 ## generate a pseudo age structure set.seed(123) R_0 = 200000 M = 0.29 ages = 1:20 n_ages = length(ages) #plot(ages, mean_length_at_age, type = &quot;l&quot;, lwd = 3, xlab = &quot;Age&quot;, ylab = &quot;Length (cm)&quot;) sel_at_age = logis(ages, sel_a50, sel_ato95) ## numbers at age N_age = vector(length = n_ages, &quot;numeric&quot;) for (age_ndx in 1:n_ages) N_age[age_ndx] = R_0 * exp(-ages[age_ndx] * M) * exp(rnorm(1,0,0.7)) N_age = N_age * sel_at_age ## vulnerable numbers at age plot(ages, N_age, ylab = &quot;Numbers&quot;, xlab = &quot;Age&quot;, main = &quot;Population age-structure&quot;, type = &quot;o&quot;) ## plot growth mean_length_at_age = richards_growth(ages, p, k, t_0, L_inf) ## randomly sample 1000 individuals with replacement for otolithing no ageing error!! ## individual_age_length_df = NULL for(i in 1:n_sample_age_length) { age_i = sample(1:n_ages, size = 1, prob = N_age) mean_length_i = richards_growth(age_i, p, k, t_0, L_inf) length_i = rnorm(1, mean_length_i, mean_length_i * cv) temp_df = data.frame(age = age_i, length = length_i) individual_age_length_df = rbind(individual_age_length_df, temp_df) } ## Simulate a tag-recapture experiment # releases release_ages = sample(1:n_ages, size = n_sample_release, prob = N_age, replace = T) release_mean_lengths = richards_growth(release_ages, p, k, t_0, L_inf) release_lengths = rnorm(n_sample_release, release_mean_lengths, release_mean_lengths * cv) individual_release_df = data.frame(release_age = release_ages, release_length = release_lengths, release_mean_length = release_mean_lengths) individual_release_df$fish_id = 1:nrow(individual_release_df) # recaptures sample uniformly without replacement fish_ndx = sample(1:nrow(individual_release_df), size = n_sample_recoveries, replace = F) individual_recovery_df = subset(individual_release_df, subset = individual_release_df$fish_id %in% fish_ndx) ## time-at liberty days randomly recovered on average between 100-600 days individual_recovery_df$time_at_liberty = rpois(n = n_sample_recoveries, lambda = runif(n_sample_recoveries,100,600)) individual_recovery_df$recovery_age = individual_recovery_df$release_age + individual_recovery_df$time_at_liberty/365 ## how to add the length increment between release and recovery? individual_recovery_df$recovery_mean_length = richards_growth(individual_recovery_df$recovery_age, p, k, t_0, L_inf) individual_recovery_df$recovery_mean_length_increment = with(individual_recovery_df, recovery_mean_length - release_mean_length) individual_recovery_df$recovery_length = with(individual_recovery_df, release_length + rlnorm(n_sample_recoveries, log(recovery_mean_length_increment), cv)) individual_recovery_df$growth_change = individual_recovery_df$recovery_length - individual_recovery_df$release_length ## visualise length at age samples ggplot(individual_age_length_df, aes(x = age, y = length)) + geom_point() + geom_line(data= data.frame(length = mean_length_at_age, age = ages), aes(x = age, y = length), col = &quot;red&quot;, linewidth = 1.2, inherit.aes = F) + labs(x = &quot;Age&quot;, y = &quot;Length&quot;) + ylim(0,NA) Assumptions in the above OM follow. \\[ l_{1,i} \\sim \\mathcal{N} \\left(\\bar{l}_{1,a}, \\sigma = \\bar{l}_{1,a} \\times cv\\right) \\] where the mean length at age release (\\(\\bar{l}_{1,a}\\)) follows the Richards growth curve defined in Equation (6.1). The age used to derive the mean length at age was a random sample with replacement from the population in shown in the earlier figure. Time at liberty was drawn from a Poisson distribution with a rate parameter randomly drawn from a uniform distribution between 100-600 days. The age at recovery \\(a_{2,i} = a_{1,i} + \\Delta_t\\). An approximation was made when calculating the length at recovery. The length increment (\\(l_{\\Delta_t}\\)) was simulated using a Log Normal distribution with the median set based on the difference between mean length at release age and mean length at recovery age. This was to ensure all recovered fish positively grew at a rate expected by the growth model (less than ideal but will do for now). \\[ l_{i,\\Delta_t} \\sim \\mathcal{LN} \\left(\\ln (\\bar{l}_{a_{2,i}} - \\bar{l}_{a_{1,i}}), \\sigma = cv\\right) \\] \\[ l_{2,i} = l_{1,i} + l_{i, \\Delta_t} \\] In theory we can now pass this data to our LEP model to back estimate growth parameters. setwd(file.path(&quot;TMB&quot;)) #sink(file = &quot;compile_output.txt&quot;) compile(file = &quot;LEPgrowth_model.cpp&quot;, flags = &quot;-Wignored-attributes -O3&quot;) #sink() dyn.load(dynlib(&quot;LEPgrowth_model&quot;)) #setwd(DIR$book) # data data = list() data$ages_from_age_length = individual_age_length_df$age data$lengths_from_age_length = individual_age_length_df$length data$lengths_at_release = individual_recovery_df$release_length data$lengths_at_recovery = individual_recovery_df$recovery_length data$time_at_liberty = individual_recovery_df$time_at_liberty / 365 data$ages_for_report = ages; data$p_bounds = c(-20, 20) data$t0_bounds = c(-6, 4) # parameters parameters = list() parameters$ln_cv_length_at_age = log(cv) parameters$ln_k = log(k) parameters$ln_L_inf = log(L_inf) parameters$logit_p = logit_general(p, data$p_bounds[1],data$p_bounds[2]) parameters$logit_t0 = logit_general(t_0, data$t0_bounds[1],data$t0_bounds[2]) parameters$ln_cv_length_release = log(0.1) parameters$ln_cv_length_recovery = log(0.1) parameters$ln_age_at_release = log(individual_recovery_df$release_age) parameters$ln_mu_age_release = log(3) parameters$ln_sd_age_release = log(1) obj_mixed_all &lt;- MakeADFun(data, parameters, random = &quot;ln_age_at_release&quot;, DLL=&quot;LEPgrowth_model&quot;) MLE_mixed_all = nlminb(start = obj_mixed_all$par, objective = obj_mixed_all$fn, gradient = obj_mixed_all$gr) MLE_mixed_all$convergence MLE_mixed_all_rep = obj_mixed_all$report(obj_mixed_all$env$last.par.best) MLE_mixed_all_sd_rep = sdreport(obj_mixed_all) plot(ages, MLE_mixed_all_rep$mean_length_at_age, type = &quot;l&quot;, lwd = 3, col = &quot;red&quot;, xlab = &quot;Age&quot;, ylab = &quot;Length (cm)&quot;, ylim = c(0, 240)) lines(ages, mean_length_at_age, col = &quot;blue&quot;, lty = 3, lwd = 3) legend(&#39;bottomright&#39;, legend = c(&quot;LEP obs error&quot;,&quot;True&quot;), col = c(&quot;red&quot;, &quot;blue&quot;), lty = c(1,2), lwd = 3) Next steps Check sensitivity to the model to starting parameters Repeat with different sample sizes Repeat with a truncated age-structure for the age-length data using a selectivity Look at Sablefish data and see if the LEP approach can be used to it Explore alternative growth models i.e., Schnute (1981) References "],["references.html", "References", " References "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
